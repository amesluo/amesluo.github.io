---
title: "SEDA Maps"
author: "Amy Luo"
date: "11/20/2021"
output:
  html_document:
    theme:
      bootswatch: 'cosmo'
    df_print: paged
  pdf_document: default
---

### Congressional District, Political Leaning, and School Funding

---

```{r echo = FALSE, message=FALSE, warning=FALSE}
# Packages
library(haven)
library(dplyr)
library(USAboundaries)
library(dplyr)
library(sf)
library(leaflet)
library(dplyr)
library(sp)
library(ggplot2)
library(stringr)
library(dplyr)
library(kableExtra)
library(plyr)
library(systemfonts)
```


### Background: Party Platform Positions on Education 

This question arose to compare the two major parties – Democrats and Republicans – to illuminate how political platforms and values have direct impacts at the level of school districts.\

An overview of the party education platforms is included below:

---

### Exploratory Analyses: Mapping Constituent Ideology by Congressional District

To begin, we first must accurately delineate between politically right and left Congressional districts.\

Here, we applied estimates of political preferences from a collection of survey measures to capture the distribution of political preferences **based on those living in an geographic area**.\

This was purposeful. As mentioned above, one concern we had was that, as a result of gerrymandering, relying only on the election results and the parties of Congressional representatives may underweight the true distribution of political preferences among those living in the District. Therefore, we drew from an opensource project, The American Ideology project, (Tausanovitch and Warshaw, 2013)[https://americanideologyproject.com/], to:

1. Explore the distribution of political preferences by geographic regions, and  
2. The magnitude, or "how radical" preferences are.

```{r echo=TRUE, message=FALSE, warning=FALSE, dpi = 200}
# Loading USAboundaries from GitHub
devtools::install_github("ropensci/USAboundaries")
devtools::install_github("ropensci/USAboundariesData")

# Using USAboundaries package, load the spatial data 2010-2020 Congressional districts
spatial <- us_congressional()


# Loading congressional ideology data for the 113th Congress from The American Ideology Project, https://americanideologyproject.com/
ideology <- read.csv('cd_113_TW_ideology_estimates.csv')


# Joining political ideology data with the spatial data
## String processing spatial dataset to remove leading zeros in "geoid"
spatial <- spatial %>% # Removing Alaska, Hawaii, and Puerto Rico
  mutate(cd_fips = str_remove(spatial$geoid, "^0+")) %>% 
  filter(state_abbr != 'AK') %>%
  filter(state_abbr != 'HI') %>%
  filter(state_abbr != 'PR')

## Selecting columns of interest from ideology dataset
ideology <- ideology %>%
  select(c('cd_fips', 'mrp_mean', 'pres_2012')) %>%
  mutate(cd_fips = as.character(cd_fips))

map <- left_join(spatial, ideology, by = 'cd_fips')

# Mapping
ideology_map <- ggplot() +
  geom_sf(data = map, 
          aes(geometry=geometry, fill=mrp_mean), alpha=2) +
  scale_fill_distiller(palette='RdBu', 
                       limits = c(-1.2,1.2), 
                       direction = -1, 
                       breaks=c(-1,0,1),
                       labels=c('Left','Center','Right'),
                       name='Political Leaning') +
  theme(panel.grid.major = element_blank(), 
        panel.background = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        plot.subtitle = element_text(size=9, color='grey45')) +
  labs(title='Contituent Political Ideology by Congressional District', 
       subtitle = 'Source: The American Ideology Project (Tausanovitch & Warshaw, 2015)')

ideology_map
```


---

### SEDA Dataset Prep


```{r message=FALSE, warning=FALSE}
# Loading SEDA dataset
full_data_yr <- read_dta("district by year by grade covariates from acs and ccd master_v1_1.dta")
# full_data_yr1 <- read_dta("https://stacks.stanford.edu/file/druid:db586ns4974/district%20by%20year%20by%20grade%20covariates%20from%20acs%20and%20ccd%20master_v1_1.dta")

# New data frame of variables of interest
dat <- full_data_yr %>% # filtering to 2013
  filter(year ==2013) 

dat <- dat[!duplicated(dat$leaid),] %>% # keeping only one observation per school district (removing grade level layer)
  select('leaid','cdcode','ppexp_tot','ppexp_inst')  

dat_na <- sum(is.na(dat$ppexp_tot), is.na(dat$ppexp_inst)) # any NAs?  
x <- is.na(dat$ppexp_inst) 
y <- is.na(dat$ppexp_tot)
nonpaired_na <- sum(any(x != y)) # Confirms that all NA values are paired, so we can remove rows for both ppexp_tot and ppexp_inst combined 
rm(x,y,nonpaired_na, dat_na)

dat <- dat[!(is.na(dat$ppexp_tot)), ] # removing 50 NA values (25 observations)

# Final clean dataset with avg values by Congressional district
dat <- ddply(dat, ~cdcode, transform, ppexp=mean(ppexp_tot),  piexp=mean(ppexp_inst))

seda <- dat[!duplicated(dat$cdcode),] %>% # keeping only one observation per Congressional district
  select(-'leaid',-'ppexp_tot',-'ppexp_inst') # dropping school district measures
```

---

#### Exploratory Analysis: Distribution of Education Funding


```{r message=FALSE, warning=FALSE, dpi = 200}
# Joining education dataset with map dataset
seda <- seda %>% 
  mutate(cd_fips=as.character(cdcode)) %>%
  select(-'cdcode')

map <- left_join(map, seda, by = 'cd_fips') 

# Per pupil Congressional district expenditure
map$z <- scale(map$ppexp)

# Per instructor Congressional district Expenditure
map$z_i <- scale(map$piexp)

# Creating indicator variable for histogram layers
hist <- map %>% 
  mutate(left = ifelse(mrp_mean>0, 'Right', 'Left')) # indicator variable for right (1) and left (0)

hist_na <- sum(is.na(hist$left)) # any NAs for unknown political ideology? 
hist <- hist[!(is.na(hist$left)), ] # removing 1 NA value
rm(hist_na)

# Distribution of per Pupil expenditures by Political Ideology
hist_p <- ggplot(hist, aes(x=z,color=left, fill=left)) +
  geom_histogram(position='identity', alpha = 0.3) +
  scale_color_manual(values=c('steelblue','salmon')) +
  scale_fill_manual(values=c('steelblue','salmon')) +
  scale_x_continuous(breaks=seq(-2,7,1),labels=seq(-2,7,1)) +
  labs(title='Distribution of Per Pupil Expediture',
       x='Scaled (standard deviation units)',
       y='Count',
       fill="Political Leaning") +
  guides(color=F) +
  theme_light()

# Distribution of per Instructor expenditures by Political Ideology
hist_i <- ggplot(hist, aes(x=z_i,color=left, fill=left)) +
  geom_histogram(position='identity', alpha = 0.3) +
  scale_color_manual(values=c('steelblue','salmon')) +
  scale_fill_manual(values=c('steelblue','salmon')) +
  scale_x_continuous(breaks=seq(-2,7,1),labels=seq(-2,7,1)) +
  labs(title='Distribution of Per Instructor Expediture',
       x='Scaled (standard deviation units)',
       y='Count',
       fill="Political Leaning") +
  guides(color=F) +
  theme_light()

## Dropping NAs to calculate group averages
z_avgs <- hist[complete.cases(hist$z),] 
z_i_avgs <- hist[complete.cases(hist$z_i),]
na_z <- sum(is.na(hist$z)) # Ensuring that NAs are properly dropped
na_z_i <- sum(is.na(hist$z_i)) # Ensuring that NAs are properly dropped
rm(na_z, na_z_i)

## Data frame with group averages
mu <- ddply(z_avgs, 'left', summarize, grp.mean=mean(z))
mu_i <- ddply(z_i_avgs, 'left', summarize, grp.mean=mean(z_i))

# Final histogram of per Pupil expenditures by Political Ideology
hist_p <- hist_p + geom_vline(xintercept=mu$grp.mean[1], color='dodgerblue', linetype='dashed') +
  geom_vline(xintercept=mu$grp.mean[2], color='tomato', linetype='longdash'); hist_p

# Final histogram of per Instructor expenditures by Political Ideology
hist_i <- hist_i + geom_vline(xintercept=mu_i$grp.mean[1], color='dodgerblue', linetype='dashed') +
  geom_vline(xintercept=mu_i$grp.mean[2], color='tomato', linetype='longdash'); hist_i
```

---

### Final Analysis: Mapping Average District Spending by Congressional District

```{r message=FALSE, warning=FALSE, dpi = 130}
library(htmlwidgets)
# Subsetting for map layers 
right <- map %>%
  subset(mrp_mean >0)
left <- map %>%
  subset(mrp_mean <0)

# Mapping per pupil Congressional District expenditure
palette <- colorBin("Greens", domain = c(-1.5,7), bins = 9)

mappp <- leaflet(map) %>%
  addProviderTiles(providers$CartoDB.Positron, group='Political') %>%
  addTiles(group='Physical') %>%
  addPolygons(data=right,
               opacity=0.5,
               weight=2,
               color='salmon',
               fillColor = ~palette(z),
              fillOpacity = 1,
               highlight=highlightOptions(weight=3,
                                        color='aliceblue',
                                        bringToFront=T),
              group="Politically Right") %>%
  addPolygons(data=left,
              opacity=0.5,
              weight=2,
              color='steelblue',
              fillColor = ~palette(z),
              fillOpacity = 1,
              highlight=highlightOptions(weight=3,
                                      color='aliceblue',
                                      bringToFront=T),
               group='Politically Left') %>%
  addLayersControl(baseGroups=c('Political', 'Physical'),
    overlayGroups=c('Politically Right', 'Politically Left'),
    options=layersControlOptions(collapsed = F))%>%
  addLegend('bottomright',
            pal=palette,
            values=~z,
            opacity=0.5,
            title='Per Pupil Expenditure, scaled') %>%
  saveWidget(here::here('widgets', 'pupil_map.html'))

# Mapping per instructor Congressional District Expenditure
palette_i <- colorBin("Greens", domain = c(-1.3,6), bins = 9)

mappi <- leaflet(map) %>%
  addProviderTiles(providers$CartoDB.Positron, group='Political') %>%
  addTiles(group='Physical') %>%
  addPolygons(data=right,
              opacity=0.5,
              weight=2,
              color='salmon',
              fillColor = ~palette_i(z_i),
              fillOpacity = 1,
              highlight=highlightOptions(weight=3,
                                        color='aliceblue',
                                        bringToFront=T),
              group="Politically Right") %>%
  addPolygons(data=left,
              opacity=0.5,
              weight=2,
              color='steelblue',
              fillColor = ~palette_i(z_i),
              fillOpacity = 1,
              highlight=highlightOptions(weight=3,
                                      color='aliceblue',
                                      bringToFront=T),
               group='Politically Left') %>%
  addLayersControl(baseGroups=c('Political', 'Physical'),
    overlayGroups=c('Politically Right', 'Politically Left'),
    options=layersControlOptions(collapsed = F))%>%
  addLegend('bottomright',
            pal=palette_i,
            values=~z_i,
            opacity=0.5,
            title='Per Instructor Expenditure, scaled') %>%
  saveWidget(here::here('widgets', 'instruc_map.html'))
```
